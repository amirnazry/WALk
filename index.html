<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Walky Talky</title>
<link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
<style>
body {
  font-family:'VT323',monospace;
  background:#000; color:#FFD700;
  text-align:center; margin:0; padding:2rem;
}
h1 {font-size:3rem;margin:1rem 0;}
p {font-size:1.2rem;}
button {
  background:#333;color:#FFD700;border:none;
  border-radius:50%;width:120px;height:120px;
  font-size:1rem;cursor:pointer;
  margin:2rem auto;display:block;
  box-shadow:0 0 20px #000 inset;
  transition:all .2s;
}
button.active {
  background:#FFD700;color:#000;
  box-shadow:0 0 20px #FFD700;
}
footer {margin-top:3rem;font-size:1rem;opacity:0.7;}
a {color:#FFD700;}
</style>
</head>
<body>
<h1>ðŸ“» Walky Talky</h1>
<p>Share this link with a friend.<br>Hold spacebar or tap to talk.<br>Release to listen.</p>
<button id="talk">Hold to Talk</button>
<p id="link"></p>
<footer>Made for quick chats. Over and out.</footer>

<script>
// --- Generate /room/ link without reloading ---
const room = location.pathname.split('/room/')[1] || Math.random().toString(36).substr(2,6);
if (!location.pathname.includes('/room/'))
  history.replaceState({}, '', '/room/' + room);
document.getElementById('link').innerHTML = `<a href="">${location.href}</a>`;

// --- Sounds ---
const beep = new Audio("https://cdn.jsdelivr.net/gh/naptha/talky-sounds/beep.mp3");
const staticNoise = new Audio("https://cdn.jsdelivr.net/gh/naptha/talky-sounds/static.mp3");
staticNoise.volume = 0.3;

// --- WebRTC + free public signaling (for test only) ---
const ws = new WebSocket('wss://signal.relay.metered.ca/?room=' + room);
const pc = new RTCPeerConnection({iceServers:[{urls:'stun:stun.l.google.com:19302'}]});
let localStream;
ws.onmessage = async e => {
  const msg = JSON.parse(e.data);
  if (msg.answer) await pc.setRemoteDescription(msg.answer);
  if (msg.offer) {
    await pc.setRemoteDescription(msg.offer);
    const a = await pc.createAnswer(); await pc.setLocalDescription(a);
    ws.send(JSON.stringify({answer:a,room}));
  }
  if (msg.candidate) pc.addIceCandidate(msg.candidate);
};
pc.onicecandidate = e => e.candidate && ws.send(JSON.stringify({candidate:e.candidate,room}));
pc.ontrack = e => { new Audio(URL.createObjectURL(e.streams[0])).play(); };

// --- Talk Button logic ---
const btn = document.getElementById('talk');
async function startMic(){
  if(!localStream){
    localStream = await navigator.mediaDevices.getUserMedia({audio:true});
    localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
    const offer = await pc.createOffer(); await pc.setLocalDescription(offer);
    ws.send(JSON.stringify({offer,room}));
  }
  beep.play(); btn.classList.add('active');
  localStream.getTracks().forEach(t => t.enabled = true);
}
function stopMic(){
  staticNoise.play(); btn.classList.remove('active');
  localStream?.getTracks().forEach(t => t.enabled = false);
}
btn.onmousedown = startMic; btn.ontouchstart = startMic;
btn.onmouseup = stopMic; btn.ontouchend = stopMic;
document.onkeydown = e => { if(e.code === 'Space') startMic(); };
document.onkeyup = e => { if(e.code === 'Space') stopMic(); };
</script>
</body>
</html>
